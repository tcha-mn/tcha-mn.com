---
import { Icon } from 'astro-icon/components';
---

<script>
  const SCRIPT_ID = 'ml-universal-script';
  const FUNC_NAME = 'ml' as const;
  const ACCOUNT_ID = '183132';
  const FORM_ID = '0rw08R';

  type MailerLiteStub = CallableFunction & {
    q: unknown[][];
    fn?: Partial<Record<string, CallableFunction>>;
  };

  type MailerLiteWindow = Window & {
    ml?: MailerLiteStub;
    __mlPendingEmbeds?: unknown[];
  };

  const clearExistingEmbed = () => {
    document.querySelectorAll<HTMLDivElement>(`.ml-embedded[data-form="${FORM_ID}"]`).forEach((container) => {
      container.innerHTML = '';
    });
    document
      .querySelectorAll<HTMLScriptElement>('script[src^="https://assets.mailerlite.com/jsonp/"]')
      .forEach((script) => script.remove());
  };

  const removeExistingScript = () => {
    const script = document.getElementById(SCRIPT_ID);
    if (script) {
      script.remove();
    }
    document
      .querySelectorAll<HTMLLinkElement>('link[href="https://assets.mailerlite.com/css/universal.css"]')
      .forEach((link) => link.remove());
    const win = window as MailerLiteWindow;
    delete (win as unknown as Record<string, unknown>)[`__${FUNC_NAME}__initialized`];

    win.__mlPendingEmbeds = [];

    const stub: MailerLiteStub = (...args: unknown[]) => {
      (stub.q = stub.q || []).push(args);
    };

    stub.q = [];
    stub.fn = {
      renderEmbeddedForm: (payload: unknown) => {
        win.__mlPendingEmbeds?.push(payload);
      },
    };

    win[FUNC_NAME] = stub;
  };

  const loadMailerLiteScript = () => {
    if (document.getElementById(SCRIPT_ID)) {
      return;
    }

    const script = document.createElement('script');
    script.async = true;
    script.src = `https://assets.mailerlite.com/js/universal.js#account=${ACCOUNT_ID}`;
    script.id = SCRIPT_ID;
    script.addEventListener('load', () => {
      const win = window as MailerLiteWindow;
      if (win.__mlPendingEmbeds?.length) {
        const embeds = [...win.__mlPendingEmbeds];
        win.__mlPendingEmbeds = [];
        embeds.forEach((payload) => {
          try {
            const facade = win[FUNC_NAME];
            facade?.fn?.renderEmbeddedForm?.(payload as never);
          } catch (error) {
            console.error('Failed to render MailerLite embed after reload', error);
          }
        });
      }
    });
    const firstScript = document.getElementsByTagName('script')[0];
    firstScript?.parentNode?.insertBefore(script, firstScript);
  };

  const ensureMailerLite = () => {
    clearExistingEmbed();
    removeExistingScript();
    loadMailerLiteScript();
  };

  const hydrateSubscribeModal = () => {
    ensureMailerLite();
  };

  document.addEventListener('astro:page-load', hydrateSubscribeModal);
  document.addEventListener('astro:after-swap', hydrateSubscribeModal);
</script>
<!-- Modal toggle -->
<button
  title="Join our mailing list"
  data-modal-target="subscribe-modal"
  data-modal-toggle="subscribe-modal"
  class="bg-primary hover:bg-darkMode dark:bg-secondary dark:text-primary hover:dark:bg-primary fixed right-10 bottom-10 flex h-12 w-12 items-center justify-center rounded-2xl rounded-bl-sm text-center text-sm font-medium text-white hover:dark:text-white"
  type="button"
>
  <Icon title="Join our mailing list" name="tabler:at" class="text-xl" />
</button>

<!-- Main modal -->
<div
  id="subscribe-modal"
  tabindex="-1"
  aria-hidden="true"
  class="fixed inset-0 z-50 hidden h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-x-hidden overflow-y-auto md:inset-0"
>
  <div aria-hidden="true" data-modal-hide="subscribe-modal" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="relative z-10 flex w-full justify-center px-4">
    <div class="relative w-full max-w-95">
      <button
        type="button"
        aria-label="Close subscribe modal"
        title="Close"
        data-modal-hide="subscribe-modal"
        class="focus:ring-primary absolute -top-5 right-2 z-20 inline-flex h-9 w-9 items-center justify-center rounded-full bg-white/90 text-gray-600 shadow hover:bg-white hover:text-gray-900 focus:ring-2 focus:outline-none dark:bg-gray-800/90 dark:text-gray-300 dark:hover:bg-gray-800"
      >
        <Icon name="tabler:x" class="h-5 w-5" />
      </button>
      <div class="ml-embedded" data-form="0rw08R"></div>
    </div>
  </div>
</div>
