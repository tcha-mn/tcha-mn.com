---
import Layout from '../layouts/PageLayout.astro';

const metadata = {
  title: 'Events Calendar | TCHA',
};
---

<Layout metadata={metadata}>
  <script>
    import dayjs from 'dayjs';
    import { Modal } from 'flowbite';
    import { Calendar } from '@fullcalendar/core';
    import dayGridPlugin from '@fullcalendar/daygrid';
    import listPlugin from '@fullcalendar/list';
    import googleCalendarPlugin from '@fullcalendar/google-calendar';

    let calendar: Calendar | undefined;

    const sanitizeLimitedHtml = (value: string | null | undefined) => {
      if (!value || typeof value !== 'string') {
        return '';
      }

      const allowedTags = new Set(['A', 'B', 'BR']);
      const doc = new DOMParser().parseFromString(value, 'text/html');

      const sanitizeNode = (node: Node) => {
        [...node.childNodes].forEach((child) => {
          if (child instanceof Element) {
            const element = child;
            const tagName = element.tagName.toUpperCase();

            if (!allowedTags.has(tagName)) {
              const textNode = doc.createTextNode(element.textContent || '');
              element.replaceWith(textNode);
              return;
            }

            if (tagName === 'A') {
              const href = element.getAttribute('href') || '';
              const isSafeHref =
                href.startsWith('http://') ||
                href.startsWith('https://') ||
                href.startsWith('mailto:') ||
                href.startsWith('tel:') ||
                href.startsWith('/');

              const target = element.getAttribute('target') || '';
              const rel = element.getAttribute('rel') || '';

              [...element.attributes].forEach((attr) => element.removeAttribute(attr.name));

              if (isSafeHref) {
                element.setAttribute('href', href);
              }
              if (target) {
                element.setAttribute('target', target);
              }
              if (target === '_blank') {
                const relParts = new Set(rel.split(/\s+/).filter(Boolean));
                relParts.add('noopener');
                relParts.add('noreferrer');
                element.setAttribute('rel', [...relParts].join(' '));
              } else if (rel) {
                element.setAttribute('rel', rel);
              }
            } else {
              [...element.attributes].forEach((attr) => element.removeAttribute(attr.name));
            }
          }

          if (child.childNodes && child.childNodes.length > 0) {
            sanitizeNode(child);
          }
        });
      };

      sanitizeNode(doc.body);
      return doc.body.innerHTML;
    };

    const htmlToText = (value: string | null | undefined) => {
      if (!value) return '';
      const div = document.createElement('div');
      div.innerHTML = value;
      return (div.textContent || '').trim();
    };

    const initCalendar = () => {
      if (calendar) {
        return;
      }

      if (!window.location.pathname.startsWith('/events/')) {
        return;
      }

      const $modalEl = document.getElementById('eventModal');
      const eventModal = new Modal($modalEl, {}, { id: 'eventModal', override: true });
      const closeButton = document.getElementById('eventModal-close');
      closeButton?.addEventListener('click', () => eventModal.hide());

      var calendarEl = document.getElementById('calendar')!;
      calendar = new Calendar(calendarEl, {
        plugins: [dayGridPlugin, listPlugin, googleCalendarPlugin],
        googleCalendarApiKey: 'AIzaSyDDtm0Kq9peyIES6MurVMzvpj0qxPd57es',
        events: {
          googleCalendarId: 'tcha-mn.com_vhub6lsh2nqen4saf0aeb9oe28@group.calendar.google.com',
        },
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,listMonth',
        },
        eventClick(info) {
          info.jsEvent.preventDefault();
          const titleEl = document.getElementById('eventModal-title');
          if (titleEl) {
            titleEl.textContent = info.event.title || '';
          }

          const subtitleEl = document.getElementById('eventModal-subtitle');
          if (subtitleEl) {
            if (info.event.allDay) {
              subtitleEl.textContent = 'All Day';
            } else if (info.event.start && info.event.end) {
              subtitleEl.textContent = `${dayjs(info.event.start).format('h:mm a')} - ${dayjs(info.event.end).format('h:mm a')}`;
            } else if (info.event.start) {
              subtitleEl.textContent = dayjs(info.event.start).format('h:mm a');
            } else {
              subtitleEl.textContent = 'Time TBD';
            }
          }

          const locationWrapper = document.getElementById('eventModal-location-wrapper');
          const locationEl = document.getElementById('eventModal-location');
          const rawLocation = info.event.extendedProps.location || '';
          const sanitizedLocation = sanitizeLimitedHtml(rawLocation);
          if (locationWrapper && locationEl) {
            locationWrapper.hidden = !sanitizedLocation;
            locationEl.innerHTML = sanitizedLocation;
            if (sanitizedLocation) {
              const locationText = htmlToText(sanitizedLocation);
              if (locationText) {
                const lineBreak = document.createElement('br');
                const mapLink = document.createElement('a');
                mapLink.target = '_blank';
                mapLink.rel = 'noopener noreferrer';
                mapLink.href = `https://maps.google.com/?q=${encodeURIComponent(locationText)}`;
                mapLink.textContent = 'see map';
                locationEl.appendChild(lineBreak);
                locationEl.appendChild(document.createTextNode('('));
                locationEl.appendChild(mapLink);
                locationEl.appendChild(document.createTextNode(')'));
              }
            }
          }

          const descriptionWrapper = document.getElementById('eventModal-description-wrapper');
          const descriptionEl = document.getElementById('eventModal-description');
          const rawDescription = info.event.extendedProps.description || '';
          const sanitizedDescription = sanitizeLimitedHtml(rawDescription);
          if (descriptionWrapper && descriptionEl) {
            descriptionWrapper.hidden = !sanitizedDescription;
            descriptionEl.innerHTML = sanitizedDescription;
          }
          eventModal.show();
        },
      });
      calendar.render();
    };
    document.addEventListener('astro:page-load', initCalendar);
    document.addEventListener('astro:after-swap', () => {
      calendar?.destroy();
      calendar = undefined;
    });
  </script>
  <section class="mx-auto max-w-4xl px-6 pb-12 sm:px-6 sm:pb-16 lg:pb-20">
    <div class="max-w-6xl" id="calendar"></div>
    <div
      id="eventModal"
      tabindex="-1"
      aria-hidden="true"
      class="fixed inset-0 z-50 hidden w-full overflow-y-auto bg-black/40 p-4 backdrop-blur-sm md:p-6"
    >
      <div class="relative mx-auto w-full max-w-2xl">
        <!-- Modal content -->
        <div class="relative rounded-lg bg-white shadow-2xl ring-1 ring-black/10 dark:bg-gray-700">
          <!-- Modal header -->
          <div class="flex items-start justify-between rounded-t px-5 pt-4">
            <h3 id="eventModal-title" class="text-xl font-semibold text-gray-900 lg:text-2xl dark:text-white"></h3>
            <button
              id="eventModal-close"
              type="button"
              class="ms-auto inline-flex h-8 w-8 items-center justify-center rounded-lg bg-transparent text-sm text-gray-400 hover:bg-gray-200 hover:text-gray-900 dark:hover:bg-gray-600 dark:hover:text-white"
            >
              <svg
                class="h-3 w-3"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 14 14"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path>
              </svg>
              <span class="sr-only">Close modal</span>
            </button>
          </div>
          <div class="border-b px-5 pb-2 dark:border-gray-600">
            <h4 id="eventModal-subtitle" class="text-sm text-gray-600 italic dark:text-gray-300"></h4>
          </div>
          <!-- Modal body -->
          <div class="space-y-6 p-6">
            <p id="eventModal-description-wrapper" class="text-base leading-relaxed text-gray-500 dark:text-gray-400">
              <b>Description:</b>
              <span id="eventModal-description"></span>
            </p>
            <p id="eventModal-location-wrapper" class="text-base leading-relaxed text-gray-500 dark:text-gray-400">
              <b>Location:</b>
              <span id="eventModal-location"></span>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
